// webpack4 打包缓存的插件，二次打包效率能够提升80%左右
// a plugin for webpack to provide an intermediate caching step for modules

const HardSourceWebpackPlugin = require('hard-source-webpack-plugin');

 // 使用默认配置
module.exports = {
  ...
  plugins: [
    new HardSourceWebpackPlugin()
  ]
}

// 自定义配置 
module.exports = {
  ...
  new HardSourceWebpackPlugin({
    // cacheDirectory是在高速缓存写入。将缓存存储到node_modules下
    cacheDirectory: 'node_modules/.cache/hard-source/[confighash]',
    // Either an absolute path or relative to webpack's options.context.
    // Sets webpack's recordsPath if not already set.
    recordsPath: 'node_modules/.cache/hard-source/[confighash]/records.json',
    // configHash在启动webpack实例时转换webpack配置，并用于cacheDirectory为不同的webpack配置构建不同的缓存
    configHash: function(webpackConfig) {
       // node-object-hash on npm can be used to build this.
       return require('node-object-hash')({sort: false}).hash(webpackConfig);
    },
    // 当构建时脚本或其他动态依赖项发生更改时，hard-source需要替换缓存以确保输出正确。如果散列与先前的构建不同，则将使用新的缓存
    environmentHash: {
       root: process.cwd(),
       directories: [],
       files: ['package-lock.json', 'yarn.lock'],
    },
})

}
